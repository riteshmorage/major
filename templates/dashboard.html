{% extends "base.html" %}

{% block title %}Medical Dashboard - Fetal Brain AI{% endblock %}

{% block content %}
<div class="dashboard-wrapper">
    <!-- Dashboard Header -->
    <section class="dashboard-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="dashboard-title">
                        <h1><i class="fas fa-tachometer-alt"></i> Medical Dashboard</h1>
                        <p class="dashboard-subtitle">
                            Welcome back, <strong>{{ username }}</strong>. Ready to analyze fetal brain scans?
                        </p>
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="dashboard-stats">
                        <div class="stat-item">
                            <span class="stat-number">{{ recent_analyses|length }}</span>
                            <span class="stat-label">Recent Scans</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container-fluid">
        <div class="row">
            <!-- Main Analysis Panel -->
            <div class="col-lg-8">
                <!-- Upload Section -->
                <div class="analysis-panel">
                    <div class="panel-header">
                        <h3><i class="fas fa-upload"></i> Upload & Analyze Brain Scan</h3>
                        <p>Drag and drop your fetal brain scan image or click to browse</p>
                    </div>
                    
                    <!-- Drag & Drop Upload Area -->
                    <div class="upload-container" id="uploadContainer">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                <h4>Drag & Drop Brain Scan</h4>
                                <p>or <button type="button" class="btn btn-outline-primary" id="browseBtn">Browse Files</button></p>
                                <small class="text-muted">Supported: JPG, PNG, GIF, BMP (Max: 16MB)</small>
                                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="upload-progress" id="uploadProgress" style="display: none;">
                                <div class="progress mb-3">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" id="progressBar"></div>
                                </div>
                                <p class="upload-status" id="uploadStatus">Uploading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Image Preview -->
                    <div class="image-preview-container" id="imagePreview" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="preview-card">
                                    <h5><i class="fas fa-image"></i> Original Scan</h5>
                                    <img id="originalImage" class="preview-image" alt="Original scan">
                                    <div class="image-info" id="imageInfo"></div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="preview-card">
                                    <h5><i class="fas fa-crosshairs"></i> Analysis Result</h5>
                                    <div class="result-placeholder" id="resultPlaceholder">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <p>Analyzing brain scan...</p>
                                    </div>
                                    <img id="resultImage" class="preview-image" alt="Analysis result" style="display: none;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Results -->
                <div class="results-panel" id="resultsPanel" style="display: none;">
                    <div class="panel-header">
                        <h3><i class="fas fa-chart-bar"></i> Analysis Results</h3>
                    </div>
                    
                    <div class="result-cards">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="result-card primary-result">
                                    <div class="result-icon">
                                        <i class="fas fa-brain"></i>
                                    </div>
                                    <div class="result-content">
                                        <h4>Detection Status</h4>
                                        <p class="result-value" id="detectionStatus">Analyzing...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="result-card confidence-result">
                                    <div class="result-icon">
                                        <i class="fas fa-percentage"></i>
                                    </div>
                                    <div class="result-content">
                                        <h4>Confidence Score</h4>
                                        <div class="confidence-display">
                                            <div class="confidence-circle" id="confidenceCircle">
                                                <span class="confidence-text" id="confidenceText">0%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="result-card timestamp-result">
                                    <div class="result-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="result-content">
                                        <h4>Analysis Time</h4>
                                        <p class="result-value" id="analysisTime">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Results -->
                    <div class="detailed-results mt-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-list-alt"></i> Detailed Analysis Report</h5>
                            </div>
                            <div class="card-body">
                                <div id="detailedReport">
                                    <div class="text-center">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-3">Generating detailed report...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Quick Stats -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> Quick Stats</h5>
                    </div>
                    <div class="card-body">
                        <div class="stat-row">
                            <span class="stat-label">Total Analyses</span>
                            <span class="stat-badge">{{ recent_analyses|length }}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Model Accuracy</span>
                            <span class="stat-badge success">95.5%</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Supported Classes</span>
                            <span class="stat-badge info">14</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Analyses -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5><i class="fas fa-history"></i> Recent Analyses</h5>
                        <a href="{{ url_for('history') }}" class="btn btn-sm btn-outline-primary">View All</a>
                    </div>
                    <div class="card-body">
                        {% if recent_analyses %}
                            {% for analysis in recent_analyses %}
                            <div class="recent-item">
                                <div class="recent-icon">
                                    <i class="fas fa-file-medical"></i>
                                </div>
                                <div class="recent-content">
                                    <h6>{{ analysis[0][:20] }}{% if analysis[0]|length > 20 %}...{% endif %}</h6>
                                    <p class="recent-result">{{ analysis[1] }}</p>
                                    <small class="recent-time">
                                        <i class="fas fa-clock"></i> {{ analysis[3] }}
                                    </small>
                                </div>
                                <div class="recent-confidence">
                                    <span class="confidence-badge">{{ "%.1f"|format(analysis[2] * 100) }}%</span>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted">
                                <i class="fas fa-inbox fa-2x mb-3"></i>
                                <p>No recent analyses yet.<br>Upload your first scan above!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Medical Guidelines -->
                <div class="sidebar-card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Guidelines</h5>
                    </div>
                    <div class="card-body">
                        <div class="guideline-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Use high-quality ultrasound/MRI images</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>Ensure proper contrast and clarity</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                            <span>Always consult medical professionals</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-shield-alt text-info"></i>
                            <span>Results are for research purposes</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Dashboard functionality
    class MedicalDashboard {
        constructor() {
            this.initializeUpload();
            this.bindEvents();
        }

        initializeUpload() {
            this.uploadArea = document.getElementById('uploadArea');
            this.fileInput = document.getElementById('fileInput');
            this.browseBtn = document.getElementById('browseBtn');
            
            // Drag and drop events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                this.uploadArea.addEventListener(eventName, this.preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                this.uploadArea.addEventListener(eventName, () => this.highlight(), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                this.uploadArea.addEventListener(eventName, () => this.unhighlight(), false);
            });

            this.uploadArea.addEventListener('drop', (e) => this.handleDrop(e), false);
            this.browseBtn.addEventListener('click', () => this.fileInput.click());
            this.fileInput.addEventListener('change', (e) => this.handleFiles(e.target.files));
        }

        bindEvents() {
            // Add any additional event bindings here
        }

        preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        highlight() {
            this.uploadArea.classList.add('drag-over');
        }

        unhighlight() {
            this.uploadArea.classList.remove('drag-over');
        }

        handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            this.handleFiles(files);
        }

        handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (this.validateFile(file)) {
                    this.uploadFile(file);
                }
            }
        }

        validateFile(file) {
            const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/bmp'];
            const maxSize = 16 * 1024 * 1024; // 16MB

            if (!validTypes.includes(file.type)) {
                this.showAlert('Invalid file type. Please upload an image file.', 'error');
                return false;
            }

            if (file.size > maxSize) {
                this.showAlert('File too large. Maximum size is 16MB.', 'error');
                return false;
            }

            return true;
        }

        uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // Show progress
            this.showProgress();
            
            // Preview image immediately
            this.previewImage(file);

            // Start analysis timer
            const startTime = Date.now();

            fetch('/upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                const endTime = Date.now();
                const analysisTime = ((endTime - startTime) / 1000).toFixed(1);
                
                if (data.success) {
                    this.showResults(data.results, analysisTime);
                } else {
                    this.showAlert(data.error || 'Upload failed', 'error');
                }
            })
            .catch(error => {
                console.error('Upload error:', error);
                this.showAlert('Upload failed. Please try again.', 'error');
            })
            .finally(() => {
                this.hideProgress();
            });
        }

        previewImage(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const originalImage = document.getElementById('originalImage');
                originalImage.src = e.target.result;
                
                // Show image info
                const imageInfo = document.getElementById('imageInfo');
                imageInfo.innerHTML = `
                    <small class="text-muted">
                        <i class="fas fa-file"></i> ${file.name}<br>
                        <i class="fas fa-weight"></i> ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        <i class="fas fa-calendar"></i> ${new Date().toLocaleString()}
                    </small>
                `;
                
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        showProgress() {
            document.getElementById('uploadProgress').style.display = 'block';
            const progressBar = document.getElementById('progressBar');
            let progress = 0;
            
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                
                if (progress >= 90) clearInterval(interval);
            }, 200);
        }

        hideProgress() {
            document.getElementById('uploadProgress').style.display = 'none';
        }

        showResults(results, analysisTime) {
            // Show results panel
            document.getElementById('resultsPanel').style.display = 'block';
            
            // Update detection status
            document.getElementById('detectionStatus').textContent = results.detected_abnormality;
            
            // Update confidence score with animation
            this.animateConfidence(results.confidence_score * 100);
            
            // Update analysis time
            document.getElementById('analysisTime').textContent = analysisTime + 's';
            
            // Show result image if available
            if (results.has_result_image && results.result_image_url) {
                const resultImage = document.getElementById('resultImage');
                resultImage.src = results.result_image_url;
                resultImage.style.display = 'block';
                document.getElementById('resultPlaceholder').style.display = 'none';
            }
            
            // Generate detailed report
            this.generateDetailedReport(results);
            
            // Scroll to results
            document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
        }

        animateConfidence(confidence) {
            const circle = document.getElementById('confidenceCircle');
            const text = document.getElementById('confidenceText');
            
            let current = 0;
            const increment = confidence / 50;
            
            const animation = setInterval(() => {
                current += increment;
                if (current >= confidence) {
                    current = confidence;
                    clearInterval(animation);
                }
                
                text.textContent = Math.round(current) + '%';
                
                // Color coding
                if (current >= 90) {
                    circle.className = 'confidence-circle high';
                } else if (current >= 70) {
                    circle.className = 'confidence-circle medium';
                } else {
                    circle.className = 'confidence-circle low';
                }
            }, 20);
        }

        generateDetailedReport(results) {
            const reportContainer = document.getElementById('detailedReport');
            
            const abnormalityInfo = {
                'Normal Scan': {
                    description: 'No abnormalities detected in the fetal brain scan.',
                    severity: 'None',
                    recommendations: 'Continue routine monitoring as per medical guidelines.'
                },
                'mild ventriculomegaly': {
                    description: 'Mild enlargement of brain ventricles detected.',
                    severity: 'Mild',
                    recommendations: 'Regular monitoring and follow-up scans recommended.'
                }
                // Add more abnormality info as needed
            };
            
            const info = abnormalityInfo[results.detected_abnormality] || {
                description: 'AI analysis completed.',
                severity: 'To be determined',
                recommendations: 'Consult with medical professional for interpretation.'
            };
            
            reportContainer.innerHTML = `
                <div class="report-section">
                    <h6><i class="fas fa-eye"></i> Detected Condition</h6>
                    <p><strong>${results.detected_abnormality}</strong></p>
                </div>
                
                <div class="report-section">
                    <h6><i class="fas fa-info-circle"></i> Description</h6>
                    <p>${info.description}</p>
                </div>
                
                <div class="report-section">
                    <h6><i class="fas fa-exclamation-triangle"></i> Severity Level</h6>
                    <p><span class="severity-badge">${info.severity}</span></p>
                </div>
                
                <div class="report-section">
                    <h6><i class="fas fa-clipboard-list"></i> Recommendations</h6>
                    <p>${info.recommendations}</p>
                </div>
                
                <div class="report-section">
                    <h6><i class="fas fa-chart-bar"></i> Technical Details</h6>
                    <ul class="technical-details">
                        <li>Model: YOLOv5 Fetal Brain Detection</li>
                        <li>Confidence Score: ${(results.confidence_score * 100).toFixed(1)}%</li>
                        <li>Image: ${results.original_filename}</li>
                        <li>Analysis Date: ${new Date().toLocaleString()}</li>
                    </ul>
                </div>
                
                <div class="alert alert-warning mt-3">
                    <strong><i class="fas fa-exclamation-triangle"></i> Medical Disclaimer:</strong>
                    This AI analysis is for research and educational purposes only. 
                    Always consult qualified medical professionals for clinical decisions.
                </div>
            `;
        }

        showAlert(message, type) {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert at top of dashboard
            const dashboard = document.querySelector('.dashboard-wrapper');
            dashboard.insertBefore(alert, dashboard.firstChild);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    }

    // Initialize dashboard when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        new MedicalDashboard();
    });
</script>
{% endblock %}